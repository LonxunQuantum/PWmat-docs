---
sidebar_position: 0
---

# GPUMD

GPUMD is a highly efficient, GPU-based general-purpose molecular dynamics software package that enables training and using neuroevolution potentials (NEPs).

You can visit the [GPUMD](https://github.com/brucefan1983/GPUMD) source repository for more details on GPUMD.

The version of GPUMD in our PWMLFF is `(tag v3.9.1)`.

## NEP model training

### Input file settings

The input file for training NEP model is similar to the input files for Linear, NN, and DP models. The simplest input settings are shown below, specifying the `model type` as NEP, the order of atom types, and a list of MOVEMENT files used for training. All other parameters use default values and are outputted to a std_input.json file before training for user inspection. Users can also modify the desired parameters in the std_input.json file and use it as the input file for training.

Please note that the `nep_in_file` mentioned here is an optional setting. The `nep.in` file is the native input control file required for training NEP models in GPUMD. Users can specify the path to this file in the input control JSON file. Alternatively, users can set the NEP input parameters directly in the `model` section, as shown in the std_input.json example. This allows users to define the NEP input parameters within the JSON file itself, without the need for a separate nep.in file.

```json
{
  "model_type": "NEP",
  "atom_type": [28, 44, 45, 46, 77],
  "nep_in_file": "nep.in",
  "raw_files": [
    "./mvm_data/init_mvm_19_300",
    "./mvm_data/init_mvm_21_300",
    "./mvm_data/init_mvm_23_300",
    "./mvm_data/init_mvm_7_300"
  ]
}
```

The standard `std_input.json` file is as follows：

```json
{
  "model_type": "NEP",
  "atom_type": [28, 44, 45, 46, 77],
  "max_neigh_num": 100,
  "seed": 2023,
  "model_num": 1,
  "train_valid_ratio": 0.8,
  "recover_train": true,
  "model": {
    "version": 4,
    "type": "5 Ni Ru Rh Pd Ir",
    "model_type": 0,
    "prediction": 0,
    "cutoff": [8, 4],
    "n_max": [4, 4],
    "basis_size": [8, 8],
    "l_max": [4, 2, 0],
    "neuron": 30,
    "lambda_1": -1,
    "lambda_2": -1,
    "lambda_e": 1.0,
    "lambda_f": 1.0,
    "lambda_v": 0.1,
    "batch": 1000,
    "population": 50,
    "generation": 100000
  },
  "work_dir": "work_dir",
  "reserve_work_dir": false,
  "raw_files": [
    "./mvm_data/init_mvm_19_300",
    "./mvm_data/init_mvm_21_300",
    "./mvm_data/init_mvm_23_300",
    "./mvm_data/init_mvm_7_300"
  ]
}
```

The standard `nep.in` file input is as follows. To obtain detailed instructions on how to configure the nep.in file for GPUMD's NEP executable, please refer to the [GPUMD documentation](https://gpumd.org/nep/index.html).

```text
    version 4
    type 5 Ni Ru Rh Pd Ir
    model_type 0
    prediction 0
    cutoff 8 4
    n_max 4 4
    basis_size 12 12
    l_max 4 2 0
    neuron 100
    generation 100000
```

### Training

To train an NEP model, you can execute the following command in the directory where the `nep.json` file is located.

```bash
`PWMLFF train nep.json`
```

### Output files after training

After training is completed, a model_record directory will be created in the current directory. It will contain the following 10 files.

`nep.txt`，`energy_train.out`，`force_train.out`，`virial_train.out`，`energy_test.out`，`force_test.out`，`virial_test.out`，`loss.out`，`nep.restart`，`nep.in`

- `nep.txt`: The NEP force field file generated after training completion.
- `energy_train.out`, `force_train.out`, `virial_train.out`: The inference results of the trained model on the training dataset for energy, force, and virial quantities.
- `energy_test.out`, `force_test.out`, `virial_test.out`: The inference results of the trained model on the test dataset for energy, force, and virial quantities.
- `loss.out`: The file that records the error statistics during the training process.
- `nep.restart`: A restart file used to resume training after an interruption.
- `nep.in`: The input file used to initiate the NEP training process, automatically generated by the system.

Please note that these descriptions provide an overview of the purpose and content of each file.

## GPUMD

For performing NEP molecular dynamics with GPUMD, the input files are similar to those for Linear\NN\DP models.
You need to prepare an input control JSON file. The complete input parameters are shown below:

```json
{
    "potential_file" : "./model_record/nep.txt",
    "run_in_file": "run.in",
    "md_init_config": "atom.config",
    "format":"pwmat/config",
    "basis_in_file":"basis.in",
    "kpoints_in_file":"kpoints.in"
}
```

### potential_file
This parameter is the path to the NEP force field file.

### run_in_file
This parameter is the path to the GPUMD molecular dynamics control file `run.in`. For the parameters in the `run.in` file, please refer to the [GPUMD manual run.in](https://gpumd.org/dev/gpumd/input_files/run_in.html).

### md_init_config
This parameter is the path to the initial MD structure file.

### format
This parameter specifies the type of the initial structure file. Here, the following formats are supported:
```
atom.config file, format="pwmat/config"
POSCAR file, format="vasp/poscar"
config.lmp LAMMPS input structure file, format="lammps/lmp"
Extended XYZ format file, format="xyz"
```

### basis_in_file
This file is used to define the unit cell for phonon calculations. The file format is as follows:
```txt
N_basis
id(0) mass(0)
id(1) mass(1)
...
id(N_basis-1) mass(N_basis-1)
map(0)
map(1)
...
map(N-1)
```
Here, `N_basis` is the number of atoms in the unit cell. For example, it can be 2 for diamond silicon if you use the primitive cell as the unit cell. The next `N_basis` lines contain the atom indices (using the order as in the simulation model file, starting from 0) and masses for the basis atoms.

The remaining N lines map the N atoms in the simulation model to the basis atoms. If the n-th atom in the simulation model file is equivalent to (under translation) the m-th basis atom in the unit cell, we have map(n)=m.

### kpoints_in_file
This file is used to set the k-points for phonon spectrum calculations. The file format is as follows:
```txt
N_kpoints
kx(0) ky(0) kz(0)
kx(1) ky(1) kz(1)
...
kx(N_kpoints-1) ky(N_kpoints-1) kz(N_kpoints-1)
```
The first line `N_kpoints` is the number of k-points.
Each subsequent line gives the k-vector (in units of 1/Å). The user has to make sure that the k-vectors are defined in the reciprocal space with respect to the unit cell chosen.

### Running

After preparing the above files, execute the command in the directory where the JSON file is located.

```bash
PWMLFF gpumd gpumd_lisi.json
```

After running the GPUMD molecular dynamics simulation, a directory named gpumd_work_dir will be created in the same directory as the JSON file. This directory will contain the results of the molecular dynamics execution and will include 6 files. 

`dos.out`, `gpumd.log`, `model.xyz`, `mvac.out`, `nep.txt`, `run.in`

## NEP for Lammps
We also provide a Lammps interface for NEP, supporting simulations on CPUs.

### Input File Settings

Use the `nep.txt` force field file generated after training for Lammps simulations.

To use the force field file generated by PWMLFF, the example input file for Lammps is as follows:

```bash
pair_style nep nep.txt
pair_coeff * *
```

### Running
You can execute with the following command, where 24 indicates using 24 CPU cores. You can modify it according to your actual resource situation.

```bash
mpirun -np 24 lmp_mpi -in in.lammps
```
